<html>
<head>
    <script>
        let ws = null;

        function doConnect(addr) {
            if(ws == null){
                ws = new WebSocket("ws://" + addr);
            }
            else{
                alert("you are already in chatroom");
            }
            ws.onopen = () => {
                document.getElementById("log").value += ("Connection opened\n");
            };
            ws.onmessage = (event) => {
                var info = JSON.parse(event.data);
                if(info.msg_id == 101){
                    document.getElementById("log").value += ("server:" + info.data + "\n");
                }
                else if(info.msg_id == 102){
                    document.getElementById("log").value += (info.name + ":" + info.data + "\n");
                }
                
            };
            ws.onclose = () => {
                document.getElementById("log").value += ("Connection closed\n");
            };
        }

        document.addEventListener("DOMContentLoaded", (event) => {
            document.getElementById("btn_connect").onclick = () => {
                let server_addr = document.getElementById("server_addr").value;
                doConnect(server_addr);
            };

            document.getElementById("btn_send").onclick = () => {
                let msg = document.getElementById("message").value;
                let user_name = document.getElementById("name").value;

                if(user_name == ''){
                    alert("please input name!");
                    return;
                }
                var messageObj = {'msg_id':102,'name':user_name,'data':msg};
                var messageJson = JSON.stringify(messageObj);//转换为json字符串
        
                ws.send(messageJson);
  
                document.getElementById("log").value += ("Send: " + msg + "\n");
            };
        });
    </script>
</head>
<body>

<div id="header">
    <h1 align="left">WebSocket Client</h1>
    Server: <input id="server_addr" type="text" value="106.13.232.15:9998">
    <input id="btn_connect" type="button" value="Connect!"><br/><br/>
    
    Name: <input id="name" type="text" value=""><br/><br/>
    
    Message: <input id="message" type="text" value="">
    <input id="btn_send" type="button" value="Send"><br/><br/>

    <textarea cols="250" id="log" rows="50"></textarea>
</div>
</body>
</html>
